<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Administração</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
    <link rel="stylesheet" href="/css/admin-dashboard.css">
    <script
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCAwvAt4l0Pkb1c52FLUE-ttVxm4YZ9J8M&libraries=drawing"></script>
    <style>
        /* Animação para o efeito de fade-in */
        .info-window {
            opacity: 0;
            animation: fadeIn 0.5s forwards;
        }

        @keyframes fadeIn {
            0% {
                opacity: 0;
                transform: scale(0.8);
            }

            100% {
                opacity: 1;
                transform: scale(1);
            }
        }

        /* Estilo do conteúdo da janela de informação */
        .info-window-content {
            font-size: 14px;
            /* Tamanho de fonte ajustado */
            font-weight: bold;
            padding: 8px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            background-color: white;
            transition: transform 0.2s ease;
        }

        .info-window-content:hover {
            transform: scale(1.05);
        }
    </style>
</head>

<body>
    <main>
        <div class="container mt-5">
            <h2>Dashboard de Administração</h2>
            <ul class="nav nav-tabs" id="adminTab" role="tablist">
                <li class="nav-item">
                    <a class="nav-link active" id="usuarios-tab" data-toggle="tab" href="#usuarios" role="tab"
                        aria-controls="usuarios" aria-selected="true">Usuários</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="cadastros-tab" data-toggle="tab" href="#cadastros" role="tab"
                        aria-controls="cadastros" aria-selected="false">Cadastros</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="relatorios-tab" data-toggle="tab" href="#relatorios" role="tab"
                        aria-controls="relatorios" aria-selected="false">Relatórios</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="graficos-tab" data-toggle="tab" href="#graficos" role="tab"
                        aria-controls="graficos" aria-selected="false">Gráficos</a>
                </li>
            </ul>
            <div class="tab-content" id="adminTabContent">
                <div class="tab-pane fade show active" id="usuarios" role="tabpanel" aria-labelledby="usuarios-tab">
                    <h3>Usuários por Localização</h3>
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <select class="form-control" id="estadoSelect" onchange="carregarMunicipios(this.value)">
                                <option>Selecione um Estado</option>
                                <!-- Estados carregados dinamicamente -->
                            </select>
                        </div>
                        <div class="col-md-4">
                            <select class="form-control" id="municipioSelect"
                                onchange="filtrarUsuariosPorMunicipio(this.value)">
                                <option>Selecione um Município</option>
                                <!-- Municípios carregados dinamicamente -->
                            </select>
                        </div>
                    </div>
                    <h3>Usuários que Solicitaram Cadastro</h3>
                    <table class="table table-striped">
                        <thead class="thead-dark">
                            <tr>
                                <th>ID</th>
                                <th>Nome</th>
                                <th>Email</th>
                                <th>Status</th>
                                <th>Cargo</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="userTableBody">
                            <!-- Os usuários serão carregados aqui via JavaScript -->
                        </tbody>
                    </table>
                </div>
                <div class="tab-pane fade" id="cadastros" role="tabpanel" aria-labelledby="cadastros-tab">
                    <h3>Cadastro de Zoneamentos</h3>
                    <div class="container mt-5">
                        <form id="zoneamento-form">
                            <div id="zoneamentos-list">
                                <!-- Lista de zoneamentos adicionados dinamicamente -->
                            </div>
                            <button type="button" id="add-zoneamento" class="btn btn-secondary mb-2">Adicionar
                                Zoneamento</button>
                            <button type="submit" class="btn btn-primary">Salvar Todos Zoneamentos</button>
                        </form>
                        <div id="map" class="mt-4" style="height: 500px;"></div>
                    </div>
                    <hr>
                    <h3>Cadastro de Pontos de Parada</h3>
                    <div class="container mt-5">
                        <form id="ponto-parada-form">
                            <div class="form-group">
                                <label for="zoneamento-select">Selecionar Zoneamento</label>
                                <select id="zoneamento-select" class="form-control" required>
                                    <!-- Opções carregadas dinamicamente -->
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="nome-ponto">Nome do Ponto de Parada</label>
                                <input type="text" id="nome-ponto" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label for="endereco-ponto">Endereço do Ponto de Parada</label>
                                <input type="text" id="endereco-ponto" class="form-control" required>
                            </div>
                            <button type="button" id="geocode-button" class="btn btn-secondary mb-2">Obter
                                Coordenadas</button>
                            <div class="form-group">
                                <label for="lat-ponto">Latitude</label>
                                <input type="text" id="lat-ponto" class="form-control" readonly>
                            </div>
                            <div class="form-group">
                                <label for="lng-ponto">Longitude</label>
                                <input type="text" id="lng-ponto" class="form-control" readonly>
                            </div>
                            <button type="submit" class="btn btn-primary">Salvar Ponto de Parada</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- JavaScript necessário para o funcionamento do mapa -->
    <script>
        let map;
        let drawingManager;
        let selectedShape;
        const shapes = [];
        const zoneamentos = [];
        const zoneamentoForm = document.getElementById('zoneamento-form');
        const zoneamentosList = document.getElementById('zoneamentos-list');
        const addZoneamentoBtn = document.getElementById('add-zoneamento');
        const pontoParadaForm = document.getElementById('ponto-parada-form');
        const zoneamentoSelect = document.getElementById('zoneamento-select');
        const geocodeButton = document.getElementById('geocode-button');
        const latPonto = document.getElementById('lat-ponto');
        const lngPonto = document.getElementById('lng-ponto');

        function initMap() {
            map = new google.maps.Map(document.getElementById('map'), {
                center: { lat: -6.530080, lng: -49.851571 },
                zoom: 15,
                mapTypeId: 'terrain'
            });

            // Inicializa o gerenciador de desenho para desenhar polígonos de zoneamento
            drawingManager = new google.maps.drawing.DrawingManager({
                drawingMode: google.maps.drawing.OverlayType.POLYGON,
                drawingControl: true,
                drawingControlOptions: {
                    position: google.maps.ControlPosition.TOP_CENTER,
                    drawingModes: ['polygon']
                },
                polygonOptions: {
                    editable: true,
                    fillOpacity: 0.35
                }
            });
            drawingManager.setMap(map);

            google.maps.event.addListener(drawingManager, 'overlaycomplete', function (event) {
                if (event.type === google.maps.drawing.OverlayType.POLYGON) {
                    const polygon = event.overlay;
                    shapes.push(polygon);

                    google.maps.event.addListener(polygon, 'click', function () {
                        setSelection(polygon);
                    });

                    setSelection(polygon);
                }
            });

            addZoneamentoBtn.addEventListener('click', function () {
                addZoneamentoFields();
            });

            zoneamentoForm.addEventListener('submit', saveAllZoneamentos);
            pontoParadaForm.addEventListener('submit', savePontoParada);
            geocodeButton.addEventListener('click', geocodeAddress);

            // Carrega zoneamentos existentes e pontos de parada
            loadExistingZoneamentos();
            loadZoneamentosForPontosParada();
        }

        function loadZoneamentosForPontosParada() {
            fetch('/api/zoneamentos')
                .then(response => response.json())
                .then(data => {
                    zoneamentoSelect.innerHTML = '<option value="">Selecione um Zoneamento</option>';
                    data.forEach(zoneamento => {
                        const option = document.createElement('option');
                        option.value = zoneamento.id;
                        option.textContent = zoneamento.nome;
                        zoneamentoSelect.appendChild(option);
                    });
                })
                .catch(error => console.error('Erro ao carregar zoneamentos:', error));
        }

        function geocodeAddress() {
            const address = document.getElementById('endereco-ponto').value;
            if (!address) {
                alert('Por favor, preencha o endereço do ponto de parada.');
                return;
            }

            fetch(`https://maps.googleapis.com/maps/api/geocode/json?address=${encodeURIComponent(address)}&key=${GOOGLE_MAPS_API_KEY}`)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'OK') {
                        const location = data.results[0].geometry.location;
                        latPonto.value = location.lat;
                        lngPonto.value = location.lng;
                        alert('Coordenadas obtidas com sucesso!');
                    } else {
                        alert('Não foi possível obter as coordenadas. Verifique o endereço informado.');
                    }
                })
                .catch(error => console.error('Erro ao acessar API de geocodificação:', error));
        }

        function savePontoParada(event) {
            event.preventDefault();

            const zoneamentoId = zoneamentoSelect.value;
            const nomePonto = document.getElementById('nome-ponto').value;
            const endereco = document.getElementById('endereco-ponto').value;
            const lat = parseFloat(latPonto.value);
            const lng = parseFloat(lngPonto.value);

            if (!zoneamentoId || !nomePonto || !endereco || !lat || !lng) {
                alert('Por favor, preencha todos os campos e obtenha as coordenadas antes de salvar.');
                return;
            }

            const pontoParadaData = {
                nome: nomePonto,
                endereco: endereco,
                lat: lat,
                lng: lng,
                zoneamento_id: parseInt(zoneamentoId)
            };

            fetch('/api/pontos_parada', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(pontoParadaData)
            })
                .then(response => response.json())
                .then(data => {
                    alert('Ponto de parada salvo com sucesso!');
                    pontoParadaForm.reset();
                    latPonto.value = '';
                    lngPonto.value = '';
                })
                .catch(error => {
                    console.error('Erro ao salvar ponto de parada:', error);
                });
        }

        window.onload = initMap;
    </script>
    <script src="/js/admin.js"></script>
</body>

</html>