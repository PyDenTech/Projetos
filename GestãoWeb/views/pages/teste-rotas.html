<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rastrear Localização e Gerar GPX</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
</head>

<body>
    <h1>Rastrear Localização e Gerar GPX</h1>
    <button id="startTracking">Iniciar Rastreamento</button>
    <button id="stopTracking" disabled>Parar Rastreamento</button>
    <a id="downloadLink" href="#" download="track.gpx" style="display:none;">Baixar GPX</a>
    <div id="map" style="height: 500px;"></div>

    <script>
        let watchId;
        let trackingData = [];
        let map;
        let polyline;

        document.getElementById('startTracking').addEventListener('click', startTracking);
        document.getElementById('stopTracking').addEventListener('click', stopTracking);

        function startTracking() {
            if (navigator.geolocation) {
                watchId = navigator.geolocation.watchPosition(onSuccess, onError, {
                    enableHighAccuracy: true,
                    maximumAge: 0,
                    timeout: 5000
                });
                document.getElementById('startTracking').disabled = true;
                document.getElementById('stopTracking').disabled = false;
            } else {
                alert('Geolocation não é suportada por este navegador.');
            }

            // Inicializar o mapa
            if (!map) {
                map = L.map('map').setView([0, 0], 13); // Centraliza o mapa em uma localização padrão

                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 19,
                }).addTo(map);

                polyline = L.polyline([], { color: 'blue' }).addTo(map);
            }
        }

        function stopTracking() {
            if (watchId) {
                navigator.geolocation.clearWatch(watchId);
                document.getElementById('startTracking').disabled = false;
                document.getElementById('stopTracking').disabled = true;
                generateGPX();
            }
        }

        function onSuccess(position) {
            const { latitude, longitude, altitude } = position.coords;
            const timestamp = position.timestamp;
            trackingData.push({
                lat: latitude,
                lon: longitude,
                alt: altitude || 0,
                time: new Date(timestamp).toISOString()
            });

            // Adicionar ponto à polilinha e ajustar a visualização do mapa
            const latLng = [latitude, longitude];
            polyline.addLatLng(latLng);
            map.setView(latLng);
        }

        function onError(error) {
            console.error(`Erro ao obter localização: ${error.message}`);
        }

        function generateGPX() {
            const gpxData = `<?xml version="1.0" encoding="UTF-8"?>
<gpx version="1.1" creator="Geolocation Tracker">
    <trk>
        <name>Rota</name>
        <trkseg>
            ${trackingData.map(point => `
            <trkpt lat="${point.lat}" lon="${point.lon}">
                <ele>${point.alt}</ele>
                <time>${point.time}</time>
            </trkpt>`).join('')}
        </trkseg>
    </trk>
</gpx>`;

            const blob = new Blob([gpxData], { type: 'application/gpx+xml' });
            const file = new File([blob], 'track.gpx', { type: 'application/gpx+xml' });

            const formData = new FormData();
            formData.append('gpxfile', file);

            fetch('https://18.231.172.222:3000/upload', { // Use HTTPS
                method: 'POST',
                body: formData
            })
                .then(response => response.text())
                .then(data => {
                    console.log('Sucesso:', data);
                })
                .catch(error => {
                    console.error('Erro:', error);
                });

            // Para download local opcional
            const url = URL.createObjectURL(blob);
            const downloadLink = document.getElementById('downloadLink');
            downloadLink.href = url;
            downloadLink.style.display = 'block';
        }
    </script>
</body>

</html>