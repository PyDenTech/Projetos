<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>Consultar Rotas</title>
    <meta content="" name="description">
    <meta content="" name="keywords">

    <!-- Favicons -->
    <link href="/img/favicon.png" rel="icon">
    <link href="/img/apple-touch-icon.png" rel="stylesheet">

    <!-- Vendor CSS Files -->
    <link href="/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
    <link href="/vendor/boxicons/css/boxicons.min.css" rel="stylesheet">
    <link href="/vendor/quill/quill.snow.css" rel="stylesheet">
    <link href="/vendor/quill/quill.bubble.css" rel="stylesheet">
    <link href="/vendor/remixicon/remixicon.css" rel="stylesheet">
    <link href="/vendor/simple-datatables/style.css" rel="stylesheet">

    <!-- Template Main CSS File -->
    <link href="/css/style.css" rel="stylesheet">
</head>

<body>

    <!-- ======= Header ======= -->
    <header id="header" class="header fixed-top d-flex align-items-center">
        <i class="bi bi-list toggle-sidebar-btn"></i>
        <div class="d-flex align-items-center justify-content-between">
            <a href="/dashboard-escolar" class="logo d-flex align-items-center">
                <img src="/img/logo.png" alt="">
            </a>
        </div><!-- End Logo -->

        <nav class="header-nav ms-auto">
            <ul class="d-flex align-items-center">
                <li class="nav-item dropdown pe-3">
                    <a id="profile-link" class="nav-link nav-profile d-flex align-items-center pe-0" href="#"
                        data-bs-toggle="dropdown">
                        <img id="profile-image" src="/img/user.png" alt="Foto de Perfil" class="rounded-circle">
                        <span id="usuarioNome" class="d-none d-md-block dropdown-toggle ps-2"></span>
                    </a><!-- End Profile Image Icon -->

                    <ul class="dropdown-menu dropdown-menu-end dropdown-menu-arrow profile">
                        <li>
                            <a class="dropdown-item d-flex align-items-center" href="/users-profile">
                                <i class="bi bi-person"></i>
                                <span>Meu Perfil</span>
                            </a>
                        </li>
                        <li>
                            <hr class="dropdown-divider">
                        </li>
                        <li>
                            <a class="dropdown-item d-flex align-items-center" href="/users-profile">
                                <i class="bi bi-gear"></i>
                                <span>Configurações de Conta</span>
                            </a>
                        </li>
                        <li>
                            <hr class="dropdown-divider">
                        </li>
                        <li>
                            <a class="dropdown-item d-flex align-items-center" href="/faq">
                                <i class="bi bi-question-circle"></i>
                                <span>Ajuda</span>
                            </a>
                        </li>
                        <li>
                            <hr class="dropdown-divider">
                        </li>
                        <li>
                            <a class="dropdown-item d-flex align-items-center" href="#" id="logout-link">
                                <i class="bi bi-box-arrow-right"></i>
                                <span>Sair</span>
                            </a>
                        </li>
                    </ul><!-- End Profile Dropdown Items -->
                </li><!-- End Profile Nav -->
            </ul>
        </nav><!-- End Icons Navigation -->

    </header><!-- End Header -->

    <!-- ======= Sidebar ======= -->
    <aside id="sidebar" class="sidebar">
        <ul class="sidebar-nav" id="sidebar-nav">
            <!-- Conteúdo da barra lateral aqui -->
        </ul>
    </aside><!-- End Sidebar-->

    <main id="main" class="main">
        <div class="pagetitle">
            <h1>Consultar Rotas</h1>
            <nav>
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="/dashboard-escolar"><i class="bi bi-house"></i></a></li>
                    <li class="breadcrumb-item active">Consultar Rotas</li>
                </ol>
            </nav>
        </div>

        <section class="section">
            <div class="row">
                <div class="col-lg-12">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Rotas</h5>
                            <div class="d-flex justify-content-between mb-3">
                                <div>
                                    <label for="itemsPerPage" class="form-label">Exibir:</label>
                                    <select id="itemsPerPage" class="form-select form-select-sm"
                                        style="width: auto; display: inline-block;">
                                        <option value="15">15</option>
                                        <option value="50">50</option>
                                        <option value="all">Todos</option>
                                    </select>
                                </div>
                                <div>
                                    <span id="totalRotas" class="mt-3"></span>
                                </div>
                            </div>
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>Identificador Único</th>
                                            <th>Descrição</th>
                                            <th>Escolas Atendidas</th>
                                            <th>Ações</th>
                                        </tr>
                                    </thead>
                                    <tbody id="rotasTableBody">
                                        <!-- Dados das rotas serão adicionados aqui -->
                                    </tbody>
                                </table>
                            </div>
                            <div class="pagination-container mt-3">
                                <nav aria-label="Page navigation">
                                    <ul class="pagination justify-content-center">
                                        <!-- Paginação será adicionada dinamicamente aqui -->
                                    </ul>
                                </nav>
                            </div>
                            <div id="loading" style="display:none;">Carregando...</div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <footer id="footer" class="footer">
        <div class="container">
            <div class="row gy-4">
                <div class="container mt-4">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="copyright">
                                &copy; Direitos Autorais <strong><span>PyDenExpress</span></strong>. Todos os Direitos
                                Reservados
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="credits">
                                Desenvolvido por <a href="https://danilomorais.netlify.app/">Danilo de Morais</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
    </footer>

    <a href="#" class="back-to-top d-flex align-items-center justify-content-center"><i
            class="bi bi-arrow-up-short"></i></a>

    <!-- Modal para visualizar a rota -->
    <div class="modal fade" id="visualizarRotaModal" tabindex="-1" aria-labelledby="visualizarRotaModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="visualizarRotaModalLabel">Visualizar Rota</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="map" style="height: 500px;"></div>
                    <div class="mt-3">
                        <p><strong>Tempo Total:</strong> <span id="tempoTotal"></span> minutos</p>
                        <p><strong>Distância Total:</strong> <span id="distanciaTotal"></span> km</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para editar a rota -->
    <div class="modal fade" id="editarRotaModal" tabindex="-1" aria-labelledby="editarRotaModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editarRotaModalLabel">Editar Rota</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editarRotaForm">
                        <input type="hidden" id="rotaId" name="rotaId">
                        <div class="mb-3">
                            <label for="identificadorUnico" class="form-label">Identificador Único da Rota</label>
                            <input type="text" class="form-control" id="identificadorUnico" name="identificadorUnico"
                                required>
                        </div>
                        <div class="mb-3">
                            <label for="tipoRota" class="form-label">Tipo da Rota</label>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="tipoRota" id="rodoviaria"
                                    value="Rodoviária">
                                <label class="form-check-label" for="rodoviaria">Rodoviária</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="tipoRota" id="aquaviaria"
                                    value="Aquaviária">
                                <label class="form-check-label" for="aquaviaria">Aquaviária</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="tipoRota" id="mista" value="Mista">
                                <label class="form-check-label" for="mista">Mista</label>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="nomeRota" class="form-label">Nome da Rota</label>
                            <input type="text" class="form-control" id="nomeRota" name="nomeRota" required>
                        </div>
                        <div class="mb-3">
                            <label for="horariosFuncionamento" class="form-label">Horários de Funcionamento</label>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="manha" name="horariosFuncionamento"
                                    value="Manhã">
                                <label class="form-check-label" for="manha">Manhã</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="tarde" name="horariosFuncionamento"
                                    value="Tarde">
                                <label class="form-check-label" for="tarde">Tarde</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="noite" name="horariosFuncionamento"
                                    value="Noite">
                                <label class="form-check-label" for="noite">Noite</label>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="dificuldadesAcesso" class="form-label">Dificuldades de Acesso</label>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="porteira" name="dificuldadesAcesso"
                                    value="Porteira">
                                <label class="form-check-label" for="porteira">Porteira</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="mataBurro" name="dificuldadesAcesso"
                                    value="Mata-Burro">
                                <label class="form-check-label" for="mataBurro">Mata-Burro</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="colchete" name="dificuldadesAcesso"
                                    value="Colchete">
                                <label class="form-check-label" for="colchete">Colchete</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="atoleiro" name="dificuldadesAcesso"
                                    value="Atoleiro">
                                <label class="form-check-label" for="atoleiro">Atoleiro</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="ponte" name="dificuldadesAcesso"
                                    value="Ponte Rústica">
                                <label class="form-check-label" for="ponte">Ponte Rústica</label>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="areaUrbana" class="form-label">Área da Rota</label>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="areaUrbana" id="urbana" value="true">
                                <label class="form-check-label" for="urbana">Urbana</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="areaUrbana" id="rural" value="false">
                                <label class="form-check-label" for="rural">Rural</label>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="escolasAtendidas" class="form-label">Escolas Atendidas</label>
                            <input type="text" id="escolasAtendidasInput" class="form-control mb-2"
                                placeholder="Buscar escolas...">
                            <select multiple class="form-select" id="escolasAtendidas" name="escolasAtendidas">
                                <!-- Opções carregadas dinamicamente -->
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="alunosAtendidos" class="form-label">Alunos Atendidos</label>
                            <input type="text" id="alunosAtendidosInput" class="form-control mb-2"
                                placeholder="Buscar alunos...">
                            <select multiple class="form-select" id="alunosAtendidos" name="alunosAtendidos">
                                <!-- Opções carregadas dinamicamente -->
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary">Salvar</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Google Maps API -->
    <script
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCAwvAt4l0Pkb1c52FLUE-ttVxm4YZ9J8M&libraries=places,geometry"></script>
    <script src="/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async function () {
            const tableBody = document.getElementById('rotasTableBody');
            const loading = document.getElementById('loading');
            const totalRotasSpan = document.getElementById('totalRotas');
            const itemsPerPageSelect = document.getElementById('itemsPerPage');
            const paginationContainer = document.querySelector('.pagination');
            let currentPage = 1;
            let itemsPerPage = parseInt(itemsPerPageSelect.value);

            async function loadRotas() {
                tableBody.innerHTML = '';
                loading.style.display = 'block';

                try {
                    const response = await fetch(`/api/consultar-rotas-com-escolas?limit=${itemsPerPage}&offset=${(currentPage - 1) * itemsPerPage}`);
                    const data = await response.json();
                    const { rotas, totalRotas } = data;

                    tableBody.innerHTML = rotas.map(rota => `
                        <tr>
                            <td>${rota.identificador_unico}</td>
                            <td>${rota.nome_rota}</td>
                            <td>${rota.escolas_atendidas_nomes.join(', ')}</td>
                            <td>
                                <button class="btn btn-primary btn-sm" onclick="visualizarRota(${rota.id})">Visualizar</button>
                                <button class="btn btn-secondary btn-sm" onclick="editarRota(${rota.id})">Editar</button>
                            </td>
                        </tr>
                    `).join('');

                    totalRotasSpan.textContent = `Total de rotas: ${totalRotas}`;
                    renderPagination(totalRotas);
                } catch (error) {
                    console.error('Erro ao carregar rotas:', error);
                    alert('Erro ao carregar rotas. Tente novamente mais tarde.');
                } finally {
                    loading.style.display = 'none';
                }
            }

            function renderPagination(totalRotas) {
                paginationContainer.innerHTML = '';
                const pageCount = Math.ceil(totalRotas / itemsPerPage);

                for (let i = 1; i <= pageCount; i++) {
                    const li = document.createElement('li');
                    li.className = `page-item ${i === currentPage ? 'active' : ''}`;
                    li.innerHTML = `<a class="page-link" href="#">${i}</a>`;
                    li.addEventListener('click', (e) => {
                        e.preventDefault();
                        currentPage = i;
                        loadRotas();
                    });
                    paginationContainer.appendChild(li);
                }
            }

            itemsPerPageSelect.addEventListener('change', function () {
                itemsPerPage = this.value === 'all' ? 1000 : parseInt(this.value);
                currentPage = 1;
                loadRotas();
            });

            async function loadEscolasAlunos() {
                const escolasResponse = await fetch('/api/escolas');
                const escolas = await escolasResponse.json();
                const alunosResponse = await fetch('/api/alunos');
                const alunos = await alunosResponse.json();

                return { escolas, alunos };
            }

            window.visualizarRota = async function (rotaId) {
                const modal = new bootstrap.Modal(document.getElementById('visualizarRotaModal'), {
                    keyboard: false
                });

                try {
                    const response = await fetch(`/api/rotas-geradas/${rotaId}`);
                    const data = await response.json();

                    if (!data || !data.ponto_inicial || !data.ponto_final || !data.pontos_parada) {
                        alert('Nenhum traçado cadastrado para essa rota.');
                        return;
                    }

                    modal.show();

                    // Inicializar o mapa dentro do modal
                    const map = new google.maps.Map(document.getElementById('map'), {
                        center: { lat: -6.530057, lng: -49.851645 },
                        zoom: 12
                    });

                    const directionsService = new google.maps.DirectionsService();
                    const directionsRenderer = new google.maps.DirectionsRenderer();
                    directionsRenderer.setMap(map);

                    const waypoints = data.pontos_parada.split(';').map(p => {
                        const [lng, lat] = p.split(',').map(Number);
                        return { location: { lat, lng }, stopover: true };
                    });

                    const request = {
                        origin: { lat: parseFloat(data.ponto_inicial.split(',')[1]), lng: parseFloat(data.ponto_inicial.split(',')[0]) },
                        destination: { lat: parseFloat(data.ponto_final.split(',')[1]), lng: parseFloat(data.ponto_final.split(',')[0]) },
                        waypoints: waypoints,
                        travelMode: google.maps.TravelMode.DRIVING
                    };

                    directionsService.route(request, (result, status) => {
                        if (status === google.maps.DirectionsStatus.OK) {
                            directionsRenderer.setDirections(result);
                            document.getElementById('tempoTotal').textContent = (result.routes[0].legs.reduce((total, leg) => total + leg.duration.value, 0) / 60).toFixed(2);
                            document.getElementById('distanciaTotal').textContent = (result.routes[0].legs.reduce((total, leg) => total + leg.distance.value, 0) / 1000).toFixed(2);
                        } else {
                            console.error('Erro ao buscar direções:', status);
                            alert('Erro ao buscar direções. Tente novamente mais tarde.');
                        }
                    });
                } catch (error) {
                    console.error('Erro ao buscar rota gerada:', error);
                    alert('Erro ao buscar rota gerada. Tente novamente mais tarde.');
                }
            };

            window.editarRota = async function (rotaId) {
                const modal = new bootstrap.Modal(document.getElementById('editarRotaModal'), {
                    keyboard: false
                });

                try {
                    const { escolas, alunos } = await loadEscolasAlunos();

                    const response = await fetch(`/api/rotas/${rotaId}`);
                    const rota = await response.json();

                    document.getElementById('rotaId').value = rota.id;
                    document.getElementById('identificadorUnico').value = rota.identificador_unico;
                    document.getElementById('nomeRota').value = rota.nome_rota;

                    // Set the type of route radio button
                    const tipoRotaRadioButtons = document.querySelectorAll('input[name="tipoRota"]');
                    tipoRotaRadioButtons.forEach(button => {
                        if (button.value === rota.tipo_rota) {
                            button.checked = true;
                        }
                    });

                    // Set horarios funcionamento checkboxes
                    const horariosFuncionamentoCheckboxes = document.querySelectorAll('input[name="horariosFuncionamento"]');
                    if (rota.horarios_funcionamento) {
                        horariosFuncionamentoCheckboxes.forEach(checkbox => {
                            checkbox.checked = rota.horarios_funcionamento.includes(checkbox.value);
                        });
                    } else {
                        horariosFuncionamentoCheckboxes.forEach(checkbox => {
                            checkbox.checked = false;
                        });
                    }

                    // Set dificuldades acesso checkboxes
                    const dificuldadesAcessoCheckboxes = document.querySelectorAll('input[name="dificuldadesAcesso"]');
                    if (rota.dificuldades_acesso) {
                        dificuldadesAcessoCheckboxes.forEach(checkbox => {
                            checkbox.checked = rota.dificuldades_acesso.includes(checkbox.value);
                        });
                    } else {
                        dificuldadesAcessoCheckboxes.forEach(checkbox => {
                            checkbox.checked = false;
                        });
                    }

                    // Set area urbana radio buttons
                    const areaUrbanaRadioButtons = document.querySelectorAll('input[name="areaUrbana"]');
                    areaUrbanaRadioButtons.forEach(button => {
                        if (button.value === rota.area_urbana.toString()) {
                            button.checked = true;
                        }
                    });

                    const escolasAtendidas = rota.escolas_atendidas || [];
                    const alunosAtendidos = rota.alunos_atendidos || [];

                    const escolasAtendidasSelect = document.getElementById('escolasAtendidas');
                    const alunosAtendidosSelect = document.getElementById('alunosAtendidos');

                    // Clear existing options
                    escolasAtendidasSelect.innerHTML = '';
                    alunosAtendidosSelect.innerHTML = '';

                    // Add new options for escolas
                    escolas.forEach(escola => {
                        const option = document.createElement('option');
                        option.value = escola.id;
                        option.textContent = escola.nome;
                        if (escolasAtendidas.includes(escola.id)) {
                            option.selected = true;
                        }
                        escolasAtendidasSelect.appendChild(option);
                    });

                    // Add new options for alunos
                    alunos.forEach(aluno => {
                        const option = document.createElement('option');
                        option.value = aluno.id;
                        option.textContent = aluno.nome;
                        if (alunosAtendidos.includes(aluno.id)) {
                            option.selected = true;
                        }
                        alunosAtendidosSelect.appendChild(option);
                    });

                    modal.show();
                } catch (error) {
                    console.error('Erro ao carregar rota para edição:', error);
                    alert('Erro ao carregar rota para edição. Tente novamente mais tarde.');
                }
            };

            // Função para pesquisar e filtrar escolas
            document.getElementById('escolasAtendidasInput').addEventListener('input', function () {
                const filter = this.value.toLowerCase();
                const options = document.getElementById('escolasAtendidas').options;
                for (let i = 0; i < options.length; i++) {
                    const option = options[i];
                    if (option.text.toLowerCase().includes(filter)) {
                        option.style.display = '';
                    } else {
                        option.style.display = 'none';
                    }
                }
            });

            document.getElementById('editarRotaForm').addEventListener('submit', async function (e) {
                e.preventDefault();

                const formData = new FormData(this);
                const data = {
                    id: parseInt(formData.get('rotaId')),
                    identificadorUnico: formData.get('identificadorUnico'),
                    tipoRota: formData.get('tipoRota'),
                    nomeRota: formData.get('nomeRota'),
                    horariosFuncionamento: JSON.stringify(Array.from(document.querySelectorAll('input[name="horariosFuncionamento"]:checked')).map(checkbox => checkbox.value)),
                    dificuldadesAcesso: JSON.stringify(Array.from(document.querySelectorAll('input[name="dificuldadesAcesso"]:checked')).map(checkbox => checkbox.value)),
                    escolasAtendidas: JSON.stringify(Array.from(document.getElementById('escolasAtendidas').selectedOptions).map(option => option.value)),
                    alunosAtendidos: JSON.stringify(Array.from(document.getElementById('alunosAtendidos').selectedOptions).map(option => option.value)),
                    areaUrbana: formData.get('areaUrbana') === 'true'
                };

                try {
                    const response = await fetch(`/api/atualizar-rota/${data.id}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(data),
                    });

                    if (response.ok) {
                        alert('Rota atualizada com sucesso!');
                        window.location.reload();
                    } else {
                        const errorData = await response.json();
                        alert(`Erro ao atualizar rota: ${errorData.error}`);
                    }
                } catch (error) {
                    console.error('Erro ao enviar dados:', error);
                    alert('Erro ao atualizar rota. Tente novamente mais tarde.');
                }
            });

            loadRotas();
        });
    </script>
</body>

</html>