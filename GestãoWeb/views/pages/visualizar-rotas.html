<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>Visualizar Rotas</title>
    <meta content="" name="description">
    <meta content="" name="keywords">

    <!-- Favicons -->
    <link href="/img/favicon.png" rel="icon">
    <link href="/img/apple-touch-icon.png" rel="apple-touch-icon">

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

    <!-- Vendor CSS Files -->
    <link href="/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
    <link href="/vendor/boxicons/css/boxicons.min.css" rel="stylesheet">
    <link href="/vendor/quill/quill.snow.css" rel="stylesheet">
    <link href="/vendor/quill/quill.bubble.css" rel="stylesheet">
    <link href="/vendor/remixicon/remixicon.css" rel="stylesheet">
    <link href="/vendor/simple-datatables/style.css" rel="stylesheet">

    <!-- Template Main CSS File -->
    <link href="/css/style.css" rel="stylesheet">
    <script
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCAwvAt4l0Pkb1c52FLUE-ttVxm4YZ9J8M&libraries=places"></script>

    <style>
        .modal-fullscreen {
            width: 100%;
            height: 100%;
            max-width: none;
        }

        th.sortable:hover {
            cursor: pointer;
        }
    </style>

</head>

<body>

    <!-- ======= Header ======= -->
    <header id="header" class="header fixed-top d-flex align-items-center">
        <i class="bi bi-list toggle-sidebar-btn"></i>
        <div class="d-flex align-items-center justify-content-between">
            <a href="/dashboard-escolar" class="logo d-flex align-items-center">
                <img src="/img/logo.png" alt="">
            </a>
        </div><!-- End Logo -->

        <nav class="header-nav ms-auto">
            <ul class="d-flex align-items-center">
                <li class="nav-item dropdown pe-3">
                    <a id="profile-link" class="nav-link nav-profile d-flex align-items-center pe-0" href="#"
                        data-bs-toggle="dropdown">
                        <img id="profile-image" src="/img/user.png" alt="Foto de Perfil" class="rounded-circle">
                        <span id="usuarioNome" class="d-none d-md-block dropdown-toggle ps-2"></span>
                    </a><!-- End Profile Image Icon -->

                    <ul class="dropdown-menu dropdown-menu-end dropdown-menu-arrow profile">
                        <li>
                            <a class="dropdown-item d-flex align-items-center" href="/users-profile">
                                <i class="bi bi-person"></i>
                                <span>Meu Perfil</span>
                            </a>
                        </li>
                        <li>
                            <hr class="dropdown-divider">
                        </li>
                        <li>
                            <a class="dropdown-item d-flex align-items-center" href="/users-profile">
                                <i class="bi bi-gear"></i>
                                <span>Configurações de Conta</span>
                            </a>
                        </li>
                        <li>
                            <hr class="dropdown-divider">
                        </li>
                        <li>
                            <a class="dropdown-item d-flex align-items-center" href="/faq">
                                <i class="bi bi-question-circle"></i>
                                <span>Ajuda</span>
                            </a>
                        </li>
                        <li>
                            <hr class="dropdown-divider">
                        </li>
                        <li>
                            <a class="dropdown-item d-flex align-items-center" href="#" id="logout-link">
                                <i class="bi bi-box-arrow-right"></i>
                                <span>Sair</span>
                            </a>
                        </li>
                    </ul><!-- End Profile Dropdown Items -->
                </li><!-- End Profile Nav -->
            </ul>
        </nav><!-- End Icons Navigation -->
    </header><!-- End Header -->

    <!-- ======= Sidebar ======= -->
    <aside id="sidebar" class="sidebar">
        <ul class="sidebar-nav" id="sidebar-nav">
            <li class="nav-heading">Transporte Escolar</li>
            <li class="nav-item">
                <a class="nav-link collapsed" href="/dashboard-escolar">
                    <i class="bi bi-speedometer2"></i>
                    <span>Painel de Controle</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link collapsed" data-bs-target="#escolas-nav" data-bs-toggle="collapse" href="#">
                    <img src="/img/icones/escolas.svg" alt="Escolas"
                        style="width: 20px; height: 20px; margin-right: 5px; color: white;">
                    <span>Escolas</span><i class="bi bi-chevron-down ms-auto"></i>
                </a>
                <ul id="escolas-nav" class="nav-content collapse" data-bs-parent="#sidebar-nav">
                    <li>
                        <a href="/cadastrar-escolas-form">
                            <i class="bi bi-house-door"></i><span>Cadastrar</span>
                        </a>
                    </li>
                    <li>
                        <a href="/gerenciar-escolas-view">
                            <i class="bi bi-pencil-square"></i><span>Gerenciar</span>
                        </a>
                    </li>
                </ul>
            </li>
            <li class="nav-item">
                <a class="nav-link collapsed" data-bs-target="#aluno-nav" data-bs-toggle="collapse" href="#">
                    <img src="/img/icones/aluno.svg" alt="Censo Escolar"
                        style="width: 20px; height: 20px; margin-right: 5px; color: white;">
                    <span>Alunos</span><i class="bi bi-chevron-down ms-auto"></i>
                </a>
                <ul id="aluno-nav" class="nav-content collapse" data-bs-parent="#sidebar-nav">
                    <li>
                        <a href="/cadastrar-aluno-form">
                            <i class="bi bi-person-plus"></i><span>Solicitar Cadastro</span>
                        </a>
                    </li>
                    <li>
                        <a href="/gerenciar-alunos-view">
                            <i class="bi bi-pencil-square"></i><span>Gerenciar</span>
                        </a>
                    </li>
                    <li>
                        <a href="/importar-aluno-form">
                            <i class="bi bi-file-earmark-arrow-up"></i><span>Importar Dados</span>
                        </a>
                    </li>

                </ul>
            <li class="nav-item">
                <a class="nav-link" data-bs-target="#routs-nav" data-bs-toggle="collapse" href="#">
                    <img src="/img/icones/rotas.svg" alt="Escolas"
                        style="width: 20px; height: 20px; margin-right: 5px; color: white;">
                    </i><span>Rotas</span><i class="bi bi-chevron-down ms-auto"></i>
                </a>
                <ul id="routs-nav" class="nav-content" data-bs-parent="#sidebar-nav">
                    <li>
                        <a href="/cadastrar-rotas-form">
                            <i class="bi bi-plus-square"></i><span>Cadastrar Rota</span>
                        </a>
                    </li>
                    <li>
                        <a href="/desenhar-rotas-map">
                            <i class="bi bi-pencil"></i><span>Gerar Rotas</span>
                        </a>
                    </li>
                    <li>
                        <a href="/visualizar-rotas">
                            <i class="bi bi-eye"></i><span>Vizualizar Rotas</span>
                        </a>
                    </li>
                </ul>
            </li>
            <li class="nav-item">
                <a class="nav-link collapsed" data-bs-target="#driverbus-nav" data-bs-toggle="collapse" href="#">
                    <img src="/img/icones/motoristas.svg" alt="Escolas"
                        style="width: 20px; height: 20px; margin-right: 5px; color: white;">
                    <span>Motoristas</span><i class="bi bi-chevron-down ms-auto"></i>
                </a>
                <ul id="driverbus-nav" class="nav-content collapse" data-bs-parent="#sidebar-nav">
                    <li>
                        <a href="/cadastrar-motorista-form">
                            <i class="bi bi-person-plus"></i><span>Cadastrar</span>
                        </a>
                    </li>
                    <li>
                        <a href="/gerenciar-motoristas-view">
                            <i class="bi bi-pencil-square"></i><span>Gerenciar</span>
                        </a>
                    </li>
                    <li>
                        <a href="/gerar-relatorio-view">
                            <i class="bi bi-clipboard2-check"></i><span>Relatórios</span>
                        </a>
                    </li>

                </ul>
            </li>
            <li class="nav-item">
                <a class="nav-link collapsed" data-bs-target="#charts-nav" data-bs-toggle="collapse" href="#">
                    <img src="/img/icones/monitor-icone-branco.png" alt="Escolas"
                        style="width: 20px; height: 20px; margin-right: 5px; color: white;">
                    </i><span>Monitores</span><i class="bi bi-chevron-down ms-auto"></i>
                </a>
                <ul id="charts-nav" class="nav-content collapse" data-bs-parent="#sidebar-nav">
                    <li>
                        <a href="/cadastrar-monitores-form">
                            <i class="bi bi-person-plus"></i><span>Cadastrar</span>
                        </a>
                    </li>
                    <li>
                        <a href="/gerenciar-monitores-view">
                            <i class="bi bi-pencil-square"></i><span>Gerenciar</span>
                        </a>
                    </li>
                </ul>
            </li>
            <li class="nav-item">
                <a class="nav-link collapsed" data-bs-target="#fornecedores-nav" data-bs-toggle="collapse" href="#">
                    <img src="/img/icones/fornecedores.svg" alt="Escolas"
                        style="width: 20px; height: 20px; margin-right: 5px; color: white;">
                    </i><span>Fornecedor</span><i class="bi bi-chevron-down ms-auto"></i>
                </a>
                <ul id="fornecedores-nav" class="nav-content collapse" data-bs-parent="#sidebar-nav">
                    <li>
                        <a href="/cadastrar-fornecedores-form">
                            <i class="bi bi-person-plus"></i><span>Cadastrar</span>
                        </a>
                    </li>
                    <li>
                        <a href="/gerenciar-fornecedores-view">
                            <i class="bi bi-pencil-square"></i><span>Gerenciar</span>
                        </a>
                    </li>

                </ul>
            </li>
            <li class="nav-item">
                <a class="nav-link collapsed" data-bs-target="#bus-nav" data-bs-toggle="collapse" href="#">
                    <img src="/img/icones/frotas.svg" alt="Escolas"
                        style="width: 20px; height: 20px; margin-right: 5px; color: white;">
                    </i><span>Frota</span><i class="bi bi-chevron-down ms-auto"></i>
                </a>
                <ul id="bus-nav" class="nav-content collapse" data-bs-parent="#sidebar-nav">
                    <li>
                        <a href="/cadastrar-onibus-form">
                            <i class="bi bi-person-plus"></i><span>Cadastrar</span>
                        </a>
                    </li>
                    <li>
                        <a href="/gerenciar-onibus-view">
                            <i class="bi bi-pencil-square"></i><span>Gerenciar</span>
                        </a>
                    </li>
                    <li>
                        <a href="/vizualizar-onibus-map">
                            <i class="bi bi-eye"></i><span>Vizualizar</span>
                        </a>
                    </li>
                    <li>
                        <a href="/solicitar-onibus-services">
                            <i class="bi bi-file-earmark-text"></i><span>Ordem de Serviço</span>
                        </a>
                    </li>
                </ul>
            </li>
            <li class="nav-heading">Administrativo</li>
            <li class="nav-item">
                <a class="nav-link collapsed" href="/dashboard-adm">
                    <i class="bi bi-speedometer"></i>
                    <span>Painel de Controle</span>
                </a>
            <li class="nav-item">
                <a class="nav-link collapsed" data-bs-target="#car-nav" data-bs-toggle="collapse" href="#">
                    <i class="bi bi-car-front"></i><span>Frota</span><i class="bi bi-chevron-down ms-auto"></i>
                </a>
                <ul id="car-nav" class="nav-content collapse" data-bs-parent="#sidebar-nav">
                    <li>
                        <a href="/cadastrar-carro-form">
                            <i class="bi bi-person-plus"></i><span>Cadastrar</span>
                        </a>
                    </li>
                    <li>
                        <a href="/gerenciar-carros-view">
                            <i class="bi bi-pencil-square"></i><span>Gerenciar</span>
                        </a>
                    </li>
                    <li>
                        <a href="/localizar-carros-map">
                            <i class="bi bi-geo-alt-fill"></i><span>Localizar</span>
                        </a>
                    </li>
                </ul>
            </li>
            <li class="nav-item">
                <a class="nav-link collapsed" data-bs-target="#drivercar-nav" data-bs-toggle="collapse" href="#">
                    <img src="/img/icones/motoristas.svg" alt="Escolas"
                        style="width: 20px; height: 20px; margin-right: 5px; color: white;">
                    <span>Motoristas</span><i class="bi bi-chevron-down ms-auto"></i>
                </a>
                <ul id="drivercar-nav" class="nav-content collapse" data-bs-parent="#sidebar-nav">
                    <li>
                        <a href="/cadastrar-motorista-carro-form">
                            <i class="bi bi-person-plus"></i><span>Cadastrar</span>
                        </a>
                    </li>
                    <li>
                        <a href="/gerenciar-motorista-carro-form">
                            <i class="bi bi-pencil-square"></i><span>Gerenciar</span>
                        </a>
                    </li>
                </ul>
            </li>
            <li class="nav-item">
                <a class="nav-link collapsed" data-bs-target="#tarefas-nav" data-bs-toggle="collapse" href="#">
                    <i class="bi bi-list-check"></i><span>Tarefas</span><i class="bi bi-chevron-down ms-auto"></i>
                </a>
                <ul id="tarefas-nav" class="nav-content collapse" data-bs-parent="#sidebar-nav">
                    <li>
                        <a href="/cadastrar-demandas">
                            <i class="bi bi-file-earmark-text"></i><span>Nova Tarefa</span>
                        </a>
                    </li>
                    <li>
                        <a href="/tasks">
                            <i class="bi bi-person-plus"></i><span>Gerenciar Tarefas</span>
                        </a>
                    </li>
                </ul>
            </li>
            <li class="nav-heading">Controle Financeiro</li>
            <li class="nav-item">
                <a class="nav-link collapsed" data-bs-target="#fuel-nav" data-bs-toggle="collapse" href="#">
                    <i class="bi bi-droplet-half"></i><span>Abastecimento</span><i
                        class="bi bi-chevron-down ms-auto"></i>
                </a>
                <ul id="fuel-nav" class="nav-content collapse" data-bs-parent="#sidebar-nav">
                    <li>
                        <a href="/cadastrar-abastecimento-view">
                            <i class="bi bi-file-earmark-text"></i><span>Cadastrar Requisição</span>
                        </a>
                    </li>
                    <li>
                        <a href="/gerenciar-abastecimento-view">
                            <i class="bi bi-pencil-square"></i><span>Gerenciar</span>
                        </a>
                    </li>
                </ul>
            </li>
        </ul>
    </aside><!-- End Sidebar-->

    <main id="main" class="main">
        <div class="pagetitle">
            <h1>Visualizar Rotas</h1>
            <nav>
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="/dashboard-escolar"><i class="bi bi-house"></i></a></li>
                    <li class="breadcrumb-item active">Visualizar Rotas</li>
                </ol>
            </nav>
        </div>
        <section class="section">
            <div class="row">
                <div class="col-lg-12">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Rotas</h5>
                            <div class="d-flex justify-content-between mb-3">
                                <div>
                                    <label for="itemsPerPage" class="form-label">Exibir:</label>
                                    <select id="itemsPerPage" class="form-select form-select-sm"
                                        style="width: auto; display: inline-block;">
                                        <option value="10">10</option>
                                        <option value="50">50</option>
                                        <option value="all">Todas</option>
                                    </select>
                                </div>
                                <div>
                                    <span id="statusMessage" class="mt-3"></span>
                                </div>
                            </div>
                            <div class="table-responsive">
                                <table class="table table-striped" id="rotasTable">
                                    <thead class="table-dark text-center">
                                        <tr>
                                            <th class="sortable" data-sort-key="identificador_unico">Identificador Único
                                                <span class="bi bi-arrow-down-up"></span></th>
                                            <th class="sortable" data-sort-key="nome_rota">Nome da Rota <span
                                                    class="bi bi-arrow-down-up"></span></th>
                                            <th class="sortable" data-sort-key="horarios_funcionamento">Horários de
                                                Funcionamento <span class="bi bi-arrow-down-up"></span></th>
                                            <th class="sortable" data-sort-key="escolasNomes">Escolas Atendidas <span
                                                    class="bi bi-arrow-down-up"></span></th>
                                            <th>Ações</th>
                                        </tr>
                                    </thead>

                                    <tbody class="text-center">
                                        <!-- Dados das rotas -->
                                    </tbody>
                                </table>
                            </div>
                            <div class="pagination-container mt-3">
                                <nav aria-label="Page navigation">
                                    <ul class="pagination justify-content-center">
                                        <!-- Paginação será adicionada dinamicamente aqui -->
                                    </ul>
                                </nav>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        <!-- Modal de Visualização de Rota -->
        <div class="modal fade" id="visualizarRotaModal" tabindex="-1" aria-labelledby="visualizarRotaModalLabel"
            aria-hidden="true">
            <div class="modal-dialog modal-fullscreen">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="visualizarRotaModalLabel">Visualizar Rota</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div id="mapModal" style="height: 80vh;"></div>
                        <div id="detalhesRotaModal"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal de Edição -->
        <div class="modal fade" id="editRotaModal" tabindex="-1" aria-labelledby="editRotaModalLabel"
            aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="editRotaModalLabel">Editar Rota</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="editRotaForm">
                            <input type="hidden" id="editRotaId">
                            <div class="mb-3">
                                <label for="editIdentificadorUnico" class="form-label">Identificador Único</label>
                                <input type="text" class="form-control" id="editIdentificadorUnico"
                                    name="identificadorUnico" required>
                            </div>
                            <div class="mb-3">
                                <label for="editTipoRota" class="form-label">Tipo da Rota</label>
                                <select class="form-select" id="editTipoRota" name="tipoRota">
                                    <option value="Rodoviária">Rodoviária</option>
                                    <option value="Aquaviária">Aquaviária</option>
                                    <option value="Mista">Mista</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="editNomeRota" class="form-label">Nome da Rota</label>
                                <input type="text" class="form-control" id="editNomeRota" name="nomeRota" required>
                            </div>
                            <div class="mb-3">
                                <label for="editHorariosFuncionamento" class="form-label">Horários de
                                    Funcionamento</label>
                                <div>
                                    <input class="form-check-input" type="checkbox" id="editManha"
                                        name="horariosFuncionamento" value="Manhã">
                                    <label class="form-check-label" for="editManha">Manhã</label>
                                </div>
                                <div>
                                    <input class="form-check-input" type="checkbox" id="editTarde"
                                        name="horariosFuncionamento" value="Tarde">
                                    <label class="form-check-label" for="editTarde">Tarde</label>
                                </div>
                                <div>
                                    <input class="form-check-input" type="checkbox" id="editNoite"
                                        name="horariosFuncionamento" value="Noite">
                                    <label class="form-check-label" for="editNoite">Noite</label>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="editDificuldadesAcesso" class="form-label">Dificuldades de Acesso</label>
                                <div>
                                    <input class="form-check-input" type="checkbox" id="editPorteira"
                                        name="dificuldadesAcesso" value="Porteira">
                                    <label class="form-check-label" for="editPorteira">Porteira</label>
                                </div>
                                <div>
                                    <input class="form-check-input" type="checkbox" id="editMataBurro"
                                        name="dificuldadesAcesso" value="Mata-Burro">
                                    <label class="form-check-label" for="editMataBurro">Mata-Burro</label>
                                </div>
                                <div>
                                    <input class="form-check-input" type="checkbox" id="editColchete"
                                        name="dificuldadesAcesso" value="Colchete">
                                    <label class="form-check-label" for="editColchete">Colchete</label>
                                </div>
                                <div>
                                    <input class="form-check-input" type="checkbox" id="editAtoleiro"
                                        name="dificuldadesAcesso" value="Atoleiro">
                                    <label class="form-check-label" for="editAtoleiro">Atoleiro</label>
                                </div>
                                <div>
                                    <input class="form-check-input" type="checkbox" id="editPonte"
                                        name="dificuldadesAcesso" value="Ponte Rústica">
                                    <label class="form-check-label" for="editPonte">Ponte Rústica</label>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="editAreaUrbana" class="form-label">Área da Rota</label>
                                <div>
                                    <input class="form-check-input" type="radio" name="areaUrbana" id="editUrbana"
                                        value="true">
                                    <label class="form-check-label" for="editUrbana">Urbana</label>
                                </div>
                                <div>
                                    <input class="form-check-input" type="radio" name="areaUrbana" id="editRural"
                                        value="false">
                                    <label class="form-check-label" for="editRural">Rural</label>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="editEscolasAtendidas" class="form-label">Escolas Atendidas</label>
                                <select multiple class="form-select" id="editEscolasAtendidas" name="escolasAtendidas">
                                    <!-- Opções carregadas dinamicamente -->
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="editAlunosAtendidos" class="form-label">Alunos Atendidos</label>
                                <select multiple class="form-select" id="editAlunosAtendidos" name="alunosAtendidos">
                                    <!-- Opções carregadas dinamicamente -->
                                </select>
                            </div>
                            <button type="button" class="btn btn-primary" id="salvarEdicaoRota">Salvar</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer id="footer" class="footer">
        <div class="container">
            <div class="row gy-4">
                <div class="container mt-4">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="copyright">
                                &copy; Direitos Autorais <strong><span>PyDenExpress</span></strong>. Todos os Direitos
                                Reservados
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="credits">
                                Desenvolvido por <a href="https://danilomorais.netlify.app/">Danilo de Morais</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
    </footer>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>

    <!-- Vendor JS Files -->
    <script src="/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script src="/vendor/echarts/echarts.min.js"></script>
    <script src="/vendor/quill/quill.min.js"></script>
    <script src="/vendor/simple-datatables/simple-datatables.js"></script>
    <script src="/vendor/tinymce/tinymce.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <!-- Bootstrap 5 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>


    <!-- Template Main JS File -->
    <script src="/js/users-profile.js"></script>
    <script src="/js/main.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            var map;
            var directionsService;
            var directionsRenderer;
            var currentPage = 1;
            var itemsPerPage = 10;
            var allData = [];
            var currentSortColumn = null;
            var currentSortOrder = 'asc';

            // Initialize the modal map
            var modalMapInitialized = false;

            // Custom icons
            const startIcon = {
                url: 'img/icones/inicio-icone.png',
                scaledSize: new google.maps.Size(32, 32),
                anchor: new google.maps.Point(16, 32)
            };

            const endIcon = {
                url: 'img/icones/inicio-icone.png',
                scaledSize: new google.maps.Size(32, 32),
                anchor: new google.maps.Point(16, 32)
            };

            const wayPointIcon = {
                url: 'img/icones/bus-stop2.png',
                scaledSize: new google.maps.Size(32, 32),
                anchor: new google.maps.Point(16, 32)
            };

            const schoolIcon = {
                url: 'img/icones/escola-marcador.png',
                scaledSize: new google.maps.Size(32, 32),
                anchor: new google.maps.Point(16, 32)
            };

            // Carregar rotas na tabela
            fetchRotas();

            document.getElementById('itemsPerPage').addEventListener('change', function () {
                itemsPerPage = this.value === 'all' ? allData.length : parseInt(this.value);
                currentPage = 1;
                renderTable();
                renderPagination();
            });

            function fetchRotas() {
                fetch('/api/rotas')
                    .then(response => response.json())
                    .then(data => {
                        allData = data;
                        const escolaIds = [];
                        data.forEach(rota => {
                            rota.escolas_atendidas.forEach(id => {
                                if (!escolaIds.includes(id)) {
                                    escolaIds.push(id);
                                }
                            });
                        });

                        fetch('/api/escolas-nomes', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ ids: escolaIds })
                        })
                            .then(response => response.json())
                            .then(escolasData => {
                                const escolasMap = {};
                                escolasData.forEach(escola => {
                                    escolasMap[escola.id] = escola.nome;
                                });

                                allData.forEach((rota, index) => {
                                    rota.escolasNomes = rota.escolas_atendidas.map(id => escolasMap[id]).join(', ');
                                });

                                renderTable();
                                renderPagination();
                            })
                            .catch(error => console.error('Erro ao carregar nomes das escolas:', error));
                    })
                    .catch(error => console.error('Erro ao carregar rotas:', error));
            }

            function renderTable() {
                const rotasTableBody = document.getElementById('rotasTable').querySelector('tbody');
                rotasTableBody.innerHTML = '';

                const start = (currentPage - 1) * itemsPerPage;
                const end = start + itemsPerPage;
                const dataToRender = allData.slice(start, end);

                dataToRender.forEach(rota => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${rota.identificador_unico}</td>
                        <td>${rota.nome_rota}</td>
                        <td>${rota.horarios_funcionamento.join(', ')}</td>
                        <td>${rota.escolasNomes}</td>
                        <td>
                            <div class="table-actions">
                                <button class="btn btn-primary btn-sm" onclick="visualizarRota(${rota.id})">
                                    <i class="bi bi-eye"></i>
                                </button>
                                <button class="btn btn-primary btn-sm" onclick="editarRota(${rota.id})">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-danger btn-sm" onclick="excluirRota(${rota.id})">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    rotasTableBody.appendChild(row);
                });

                const quantidadeRotas = allData.length;
                document.getElementById('statusMessage').textContent = `Total de rotas: ${quantidadeRotas}`;
            }

            function renderPagination() {
                const paginationContainer = document.querySelector('.pagination');
                paginationContainer.innerHTML = '';

                const pageCount = Math.ceil(allData.length / itemsPerPage);

                for (let i = 1; i <= pageCount; i++) {
                    const li = document.createElement('li');
                    li.className = `page-item ${i === currentPage ? 'active' : ''}`;
                    li.innerHTML = `<a class="page-link" href="#">${i}</a>`;
                    li.addEventListener('click', (e) => {
                        e.preventDefault();
                        currentPage = i;
                        renderTable();
                        renderPagination();
                    });
                    paginationContainer.appendChild(li);
                }
            }

            function sortTable(columnKey) {
                currentSortOrder = currentSortColumn === columnKey && currentSortOrder === 'asc' ? 'desc' : 'asc';
                currentSortColumn = columnKey;

                allData.sort((a, b) => {
                    const aValue = a[columnKey];
                    const bValue = b[columnKey];

                    if (columnKey === 'identificador_unico') {
                        const aNumeric = aValue.replace(/[^\d]/g, '');
                        const bNumeric = bValue.replace(/[^\d]/g, '');
                        if (aNumeric !== bNumeric) {
                            return currentSortOrder === 'asc' ? aNumeric - bNumeric : bNumeric - aNumeric;
                        }
                        return currentSortOrder === 'asc' ? aValue.localeCompare(bValue) : bValue.localeCompare(aValue);
                    }

                    return currentSortOrder === 'asc' ? aValue.localeCompare(bValue) : bValue.localeCompare(aValue);
                });

                renderTable();
                renderPagination();
            }

            document.querySelectorAll('.sortable').forEach(header => {
                header.addEventListener('click', () => {
                    const columnKey = header.dataset.sortKey;
                    sortTable(columnKey);
                });
            });

            window.visualizarRota = function (rotaId) {
                fetch(`/api/rota-gerada/${rotaId}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Resposta inesperada do servidor');
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (!Array.isArray(data) || data.length === 0) {
                            alert('Nenhuma rota gerada encontrada para esta rota.');
                            return;
                        }

                        // Initialize the modal map if it hasn't been initialized yet
                        if (!modalMapInitialized) {
                            map = new google.maps.Map(document.getElementById('mapModal'), {
                                center: { lat: -6.530379, lng: -49.851744 },
                                zoom: 13
                            });
                            directionsService = new google.maps.DirectionsService();
                            directionsRenderer = new google.maps.DirectionsRenderer({
                                map: map,
                                suppressMarkers: true // We will add custom markers manually
                            });
                            modalMapInitialized = true;
                        }

                        const waypoints = data.map(coord => ({ location: new google.maps.LatLng(coord.lat, coord.lng), stopover: true }));

                        const startPoint = waypoints.shift().location;
                        const endPoint = waypoints.pop().location;

                        const request = {
                            origin: startPoint,
                            destination: endPoint,
                            waypoints: waypoints,
                            travelMode: google.maps.TravelMode.DRIVING
                        };

                        directionsService.route(request, function (result, status) {
                            if (status == google.maps.DirectionsStatus.OK) {
                                directionsRenderer.setDirections(result);

                                // Add custom markers
                                const route = result.routes[0];
                                addCustomMarkers(route, waypoints);

                                const routeLeg = route.legs[0];
                                const detalhesRotaDiv = document.getElementById('detalhesRotaModal');
                                detalhesRotaDiv.innerHTML = `
                                    <p><strong>Nome da Rota:</strong> ${rotaId}</p>
                                    <p><strong>Total de Pontos:</strong> ${waypoints.length + 2}</p>
                                    <p><strong>Distância Total:</strong> ${(routeLeg.distance.value / 1000).toFixed(2)} km</p>
                                    <p><strong>Tempo Estimado:</strong> ${Math.round(routeLeg.duration.value / 60)} minutos</p>
                                    <p><strong>Pontos:</strong></p>
                                    <ul>
                                        ${route.overview_path.map((ponto, index) => `<li>Ponto ${index + 1}: ${ponto.lat().toFixed(5)}, ${ponto.lng().toFixed(5)}</li>`).join('')}
                                    </ul>
                                `;
                            } else {
                                alert('Erro ao gerar a rota: ' + status);
                            }
                        });

                        // Open the modal
                        const visualizarRotaModal = new bootstrap.Modal(document.getElementById('visualizarRotaModal'));
                        visualizarRotaModal.show();
                    })
                    .catch(error => console.error('Erro ao visualizar rota:', error));
            };

            function addCustomMarkers(route, waypoints) {
                const leg = route.legs[0];
                // Add the start marker
                new google.maps.Marker({
                    position: leg.start_location,
                    map: map,
                    icon: startIcon,
                    title: 'Ponto Inicial'
                });

                // Add the end marker
                new google.maps.Marker({
                    position: leg.end_location,
                    map: map,
                    icon: endIcon,
                    title: 'Ponto Final'
                });

                // Add waypoints markers
                waypoints.forEach((waypoint, index) => {
                    new google.maps.Marker({
                        position: waypoint.location,
                        map: map,
                        icon: wayPointIcon,
                        title: `Ponto de Parada ${index + 1}`
                    });
                });

                // Add school markers (assuming schools are along the route, you may need to adjust this logic)
                leg.steps.forEach(step => {
                    new google.maps.Marker({
                        position: step.start_location,
                        map: map,
                        icon: schoolIcon,
                        title: 'Escola'
                    });
                });
            }

            window.editarRota = function (id) {
                fetch(`/api/rotas/${id}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Erro ao carregar dados da rota para edição');
                        }
                        return response.json();
                    })
                    .then(data => {
                        document.getElementById('editRotaId').value = data.id;
                        document.getElementById('editIdentificadorUnico').value = data.identificador_unico;
                        document.getElementById('editTipoRota').value = data.tipo_rota;
                        document.getElementById('editNomeRota').value = data.nome_rota;

                        // Marcar os checkboxes de horários de funcionamento
                        ['Manhã', 'Tarde', 'Noite'].forEach(periodo => {
                            const checkbox = document.getElementById(`edit${periodo}`);
                            if (checkbox) {
                                checkbox.checked = data.horarios_funcionamento.includes(periodo);
                            }
                        });

                        // Marcar os checkboxes de dificuldades de acesso
                        ['Porteira', 'MataBurro', 'Colchete', 'Atoleiro', 'Ponte'].forEach(dificuldade => {
                            const checkbox = document.getElementById(`edit${dificuldade}`);
                            if (checkbox) {
                                checkbox.checked = data.dificuldades_acesso.includes(dificuldade);
                            }
                        });

                        // Marcar o rádio de área urbana
                        document.getElementById('editUrbana').checked = data.area_urbana;
                        document.getElementById('editRural').checked = !data.area_urbana;

                        // Carregar as opções de escolas atendidas
                        fetch('/api/escolas')
                            .then(response => response.json())
                            .then(escolas => {
                                const escolasAtendidasSelect = document.getElementById('editEscolasAtendidas');
                                escolasAtendidasSelect.innerHTML = escolas.map(escola => `<option value="${escola.id}">${escola.nome}</option>`).join('');
                                data.escolas_atendidas.forEach(id => {
                                    const option = escolasAtendidasSelect.querySelector(`option[value="${id}"]`);
                                    if (option) {
                                        option.selected = true;
                                    }
                                });
                            });

                        // Carregar as opções de alunos atendidos
                        fetch('/api/alunos')
                            .then(response => response.json())
                            .then(alunos => {
                                const alunosAtendidosSelect = document.getElementById('editAlunosAtendidos');
                                alunosAtendidosSelect.innerHTML = alunos.map(aluno => `<option value="${aluno.id}">${aluno.nome}</option>`).join('');
                                data.alunos_atendidos.forEach(id => {
                                    const option = alunosAtendidosSelect.querySelector(`option[value="${id}"]`);
                                    if (option) {
                                        option.selected = true;
                                    }
                                });
                            });

                        const editRotaModal = new bootstrap.Modal(document.getElementById('editRotaModal'));
                        editRotaModal.show();
                    })
                    .catch(error => console.error('Erro ao carregar dados da rota para edição:', error));
            };

            document.getElementById('salvarEdicaoRota').addEventListener('click', function () {
                const id = document.getElementById('editRotaId').value;
                const identificadorUnico = document.getElementById('editIdentificadorUnico').value;
                const tipoRota = document.getElementById('editTipoRota').value;
                const nomeRota = document.getElementById('editNomeRota').value;
                const horariosFuncionamento = Array.from(document.querySelectorAll("input[name='horariosFuncionamento']:checked")).map(el => el.value);
                const dificuldadesAcesso = Array.from(document.querySelectorAll("input[name='dificuldadesAcesso']:checked")).map(el => el.value);
                const areaUrbana = document.querySelector("input[name='areaUrbana']:checked").value === 'true';
                const escolasAtendidas = Array.from(document.getElementById('editEscolasAtendidas').selectedOptions).map(option => option.value);
                const alunosAtendidos = Array.from(document.getElementById('editAlunosAtendidos').selectedOptions).map(option => option.value);

                const data = {
                    identificador_unico: identificadorUnico,
                    tipo_rota: tipoRota,
                    nome_rota: nome_rota,
                    horarios_funcionamento: horariosFuncionamento,
                    dificuldades_acesso: dificuldadesAcesso,
                    escolas_atendidas: escolasAtendidas,
                    alunos_atendidos: alunosAtendidos,
                    area_urbana: areaUrbana
                };

                fetch(`/api/rotas/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Erro ao salvar edição da rota.');
                        }
                        return response.json();
                    })
                    .then(() => {
                        alert('Rota editada com sucesso!');
                        fetchRotas();
                        const editRotaModal = bootstrap.Modal.getInstance(document.getElementById('editRotaModal'));
                        editRotaModal.hide();
                    })
                    .catch(error => console.error('Erro ao salvar edição da rota:', error));
            });

            window.excluirRota = function (id) {
                if (confirm('Tem certeza que deseja excluir esta rota?')) {
                    fetch(`/api/rotas/${id}`, {
                        method: 'DELETE'
                    })
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('Erro ao excluir rota.');
                            }
                            return response.json();
                        })
                        .then(data => {
                            alert(data.message);
                            fetchRotas();
                        })
                        .catch(error => console.error('Erro ao excluir rota:', error));
                }
            };
        });
    </script>
</body>

</html>